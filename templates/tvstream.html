<head>

  <link href="{{ url_for('streaming.static', filename='node_modules/video.js/dist/video-js.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('streaming.static', filename='node_modules/video.js/dist/video.min.js') }}"></script>

  <script src="{{ url_for('streaming.static', filename='node_modules/videojs-offset/dist/videojs-offset.min.js') }}"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/videojs-logo@latest/dist/videojs-logo.css">
  <script src="https://cdn.jsdelivr.net/npm/videojs-logo@latest/dist/videojs-logo.min.js"></script>
  
  <script>
    window.SILVERMINE_VIDEOJS_CHROMECAST_CONFIG = {
        preloadWebComponents: true,
    };
  </script>
  <link href="{{ url_for('streaming.static', filename='node_modules/@silvermine/videojs-chromecast/dist/silvermine-videojs-chromecast.css') }}" rel="stylesheet">
  <script src="{{ url_for('streaming.static', filename='node_modules/@silvermine/videojs-chromecast/dist/silvermine-videojs-chromecast.min.js') }}"></script>
  <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <style>
    .video-js {
      width: 100%;
      aspect-ratio: 4/3;
    }
  </style>
</head>

<div id="streamContainer">
  <video
      id="tvPlayer"
      class="video-js"
      preload="auto"
      controls
    >

    <source src="{{ url_for('streaming.static', filename='PM5544.mp4' ) }}" type="video/mp4">
    
    <p class="vjs-no-js">
      To view this video please enable JavaScript, and consider upgrading to a
      web browser that
      <a href="https://videojs.com/html5-video-support/" target="_blank">
        supports HTML5 video
      </a>
    </p>
  </video>
  
  <div id="info">
    <h2 id="programTitle"></h2>
    <p id="programTime"></p>
    <p id="programDescription"></p>
    <p id="nextProgram"></p>
  </div>
</div>

<script>
  const options = {
    muted:false,
    preload:"auto",
    autoplay:true,
    controls: true,
    controlBar: {
      playToggle: false,
      progressControl: false, 
      remainingTimeDisplay: false,
      volumePanel: true,  
      fullscreenToggle: true
    },
    techOrder: [ 'chromecast', 'html5' ],
    plugins: {
      chromecast: {}
    }
  };

  var player = videojs('tvPlayer', options)

  player.logo({
    image: '', //Insert link to logo here
    width: 30,
    height: 30,
    fadeDelay: null
  });

  function onProgramChanged(program){
    if (program.status === "available"){
      if (parseInt(program.offset) > parseInt(program.duration)){
        player.src(`{{ url_for("streaming.static", filename="PM5544.mp4" ) }}`);
      } else {
        player.src(`/video/${program.content_type}/${program.directory}/${program.filename}`);
      }
      document.getElementById('programTitle').innerText = program.name;
      document.getElementById('programTime').innerText = `${program.start_time} - ${program.end_time}`;

      if (program.episode_number){
          document.getElementById('programDescription').innerText = `Episode ${program.episode_number}: ${program.description}`;
      } else {
          document.getElementById('programDescription').innerText = program.description;
      }

    } else {
      player.src(`{{ url_for("streaming.static", filename="PM5544.mp4" ) }}`);
      document.getElementById('programTitle').innerText = program.name;
      document.getElementById('programTime').innerText = "";
      document.getElementById('programDescription').innerText = program.description;
    }

    player.currentTime(program.offset)

    if (program.is_rerun){
        document.getElementById('programTitle').innerText += " (R)"
    }
  }

  function create_subtitles(subtitles){
    subtitles.forEach(subtitle => {
      const track = document.createElement("track")
      track.src = subtitle.src
      track.srclang = subtitle.language
      track.label = subtitle.label

      player.appendChild(track)
    });
  }
  
  function SSE(){
    const evtSource = new EventSource("stream/current");

    evtSource.onmessage = (e) => {
      const program = JSON.parse(e.data);
      onProgramChanged(program);
    };
  }

  function Polling(){
    let currentProgram = "";
    function updateProgram() {
        fetch('/stream/current')
          .then(response => response.json())
          .then(program => {
            console.log(program)
            if (program.filename !== currentProgram) {
              currentProgram = program.filename;
              onProgramChanged(program);
            }
          });
    }

    updateProgram();
    setInterval(updateProgram, 5000);
  }

  Polling();
</script>