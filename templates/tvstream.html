<head>

  <link href="{{ url_for('streaming.static', filename='node_modules/video.js/dist/video-js.min.css') }}" rel="stylesheet">
  <script src="{{ url_for('streaming.static', filename='node_modules/video.js/dist/video.min.js') }}"></script>

  <script src="{{ url_for('streaming.static', filename='node_modules/videojs-offset/dist/videojs-offset.min.js') }}"></script>
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/videojs-logo@latest/dist/videojs-logo.css">
  <script src="https://cdn.jsdelivr.net/npm/videojs-logo@latest/dist/videojs-logo.min.js"></script>
  
  <script>
    window.SILVERMINE_VIDEOJS_CHROMECAST_CONFIG = {
        preloadWebComponents: true,
    };
  </script>
  <link href="{{ url_for('streaming.static', filename='node_modules/@silvermine/videojs-chromecast/dist/silvermine-videojs-chromecast.css') }}" rel="stylesheet">
  <script src="{{ url_for('streaming.static', filename='node_modules/@silvermine/videojs-chromecast/dist/silvermine-videojs-chromecast.min.js') }}"></script>
  <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>

  <style>
    .video-js {
      width: 100%;
      aspect-ratio: 4/3;
    }
  </style>
</head>

<div id="streamContainer">
  <video
      id="tvPlayer"
      class="video-js"
      preload="auto"
      controls
      
    >

    <source src="{{ url_for('streaming.static', filename='PM5544.mp4' ) }}" type="video/mp4">
    <track kind="captions">
    
    <p class="vjs-no-js">
      To view this video please enable JavaScript, and consider upgrading to a
      web browser that
      <a href="https://videojs.com/html5-video-support/" target="_blank">
        supports HTML5 video
      </a>
    </p>
  </video>
  
  <div id="info">
    <h2 id="programTitle"></h2>
    <p id="programTime"></p>
    <p id="programDescription"></p>
    <p id="nextProgram"></p>
  </div>
</div>

<script>
  const options = {
    muted:false,
    preload:"auto",
    autoplay:true,
    controls: true,
    controlBar: {
      playToggle: false,
      progressControl: false, 
      remainingTimeDisplay: false,
      volumePanel: true,  
      fullscreenToggle: true
    },
    techOrder: [ 'chromecast', 'html5' ],
    plugins: {
      chromecast: {}
    }
  };

  var player = videojs('tvPlayer', options)

  player.logo({
    image: '', //Insert link to logo here
    width: 30,
    height: 30,
    fadeDelay: null
  });

  let currentProgram = "";
  function updateProgram() {
    fetch('/api/current')
      .then(response => response.json())
      .then(program => {
          if (program.filename !== currentProgram) {
              console.log("Program changed!", program);
              currentProgram = program.filename;
              
              if (program.status === "off_air" || program.status === "no_program" || program.status === "unavailable") {
                  player.src(`{{ url_for("streaming.static", filename="PM5544.mp4" ) }}`);
                  document.getElementById('programTitle').innerText = program.name;
                  document.getElementById('programTime').innerText = "";
                  document.getElementById('programDescription').innerText = program.description;
              } else {
                  console.log(parseInt(program.offset));
                  console.log(parseInt(program.duration));
                  if (parseInt(program.offset) > parseInt(program.duration)){
                    player.src(`{{ url_for("streaming.static", filename="PM5544.mp4" ) }}`);
                  } else {
                    player.src(`/video/${program.content_type}/${program.directory}/${program.filename}`);
                  }
                  document.getElementById('programTitle').innerText = program.name;
                  document.getElementById('programTime').innerText = `${program.start_time} - ${program.end_time}`;
                  if (program.description){
                      if (program.episode_number){
                          document.getElementById('programDescription').innerText = `Episode ${program.episode_number}: ${program.description}`;
                      } else {
                          document.getElementById('programDescription').innerText = program.description;
                      }
                  } else {
                      document.getElementById('programDescription').innerText = program.description;
                  }
              }

              player.currentTime(program.offset)

              if (program.is_rerun){
                  document.getElementById('programTitle').innerText += " (R)"
              }
          }
      });
  }

  function calculateOffset(programStart) {
    var now = new Date();
    nowHour = now.getHours();
    nowMinutes = now.getMinutes();
    nowSeconds = now.getSeconds();

    startHour = programStart.slice(0,2);
    startMinute = programStart.slice(3,5);

    offset = 3600*(nowHour-startHour) + 60*(nowMinutes-startMinute) + nowSeconds - 10;

    return Math.max(0, offset)
  }

  updateProgram();
  setInterval(updateProgram, 1000);
</script>